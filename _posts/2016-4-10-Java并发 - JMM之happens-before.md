---
layout: post
title: Java并发 -JMM之happens-before
date:   2016-4-10
categories: "java并发"
tags: [java, jvm,并发]
author: Mark
comment: false
---

> 在JMM中，如果一个操作的执行结果需要对另一个操作可见，那么这两个操作之间必须存在happens-before关系。

happens-before原则非常重要，它是判断数据是否存在竞争、线程是否安全的主要依据。依靠这个原则，我们解决在并发环境下两操作之间是否可能存在冲突的所有问题。

下面是Java内存模型下一些“天然的”happens-before关系，这些happens-before关系无需任何同步器协助就已经存在，可以在编码中直接使用。如果两个操作之间的关系不在此列，并且无法从下列规则推导出来的话，它们就没有顺序性保障，虚拟机可以对它们随意地进行重排序。

 1. **程序次序规则：** 一个线程内，按照程序代码顺序，书写在前面的操作先行发生于书写在后面的操作。即一段代码在单线程中执行结果是有序的，尽管虚拟机，处理器会对指令重排序，并不影响执行结果，在对线程环境下无法保证正确性。
 2. **锁定规则：**一个unlock操作先行发生于后面对同一个锁的lock操作。这里指的是同一个锁，而“后面”是时间上的先后顺序。
 3. **volatitle变量规则：**对于一个volatile变量的写操作先行发生于后面对这个变量的读操作，这里“后面”同样是指时间上的先后顺序。